-- =========================================================
-- GO-SIM SCHEMA (NO DB-GENERATED IDS)
-- - FIREBASE UID IS THE PK FOR USERS
-- - ALL OTHER IDS ARE TEXT AND MUST BE GENERATED BY THE APP
-- =========================================================

-- ---------------------------------------------------------
-- UPDATED_AT TRIGGER (SHARED)
-- ---------------------------------------------------------
CREATE OR REPLACE FUNCTION UPDATE_UPDATED_AT_COLUMN()
RETURNS TRIGGER AS $$
BEGIN
  NEW.UPDATED_AT = NOW();
  RETURN NEW;
END;
$$ LANGUAGE 'plpgsql';

-- ---------------------------------------------------------
-- USERS (FIREBASE UID AS PRIMARY KEY)
-- ---------------------------------------------------------
CREATE TABLE IF NOT EXISTS USERS (
  FIREBASE_UID TEXT PRIMARY KEY,
  EMAIL TEXT NOT NULL UNIQUE,
  DISPLAY_NAME TEXT,
  PHOTO_URL TEXT,

  ROLE TEXT NOT NULL DEFAULT 'user',
  ORGANIZATION TEXT,
  PREFERENCES JSONB NOT NULL DEFAULT '{}'::JSONB,

  CREATED_AT TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  UPDATED_AT TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  LAST_LOGIN_AT TIMESTAMPTZ
);

CREATE INDEX IF NOT EXISTS IDX_USERS_EMAIL ON USERS(EMAIL);
CREATE INDEX IF NOT EXISTS IDX_USERS_ROLE ON USERS(ROLE);
CREATE INDEX IF NOT EXISTS IDX_USERS_ORGANIZATION ON USERS(ORGANIZATION);

DROP TRIGGER IF EXISTS TRG_USERS_UPDATED_AT ON USERS;
CREATE TRIGGER TRG_USERS_UPDATED_AT
BEFORE UPDATE ON USERS
FOR EACH ROW EXECUTE FUNCTION UPDATE_UPDATED_AT_COLUMN();

-- ---------------------------------------------------------
-- PROJECTS (PUBLIC_ID AS PRIMARY KEY)
-- PUBLIC_ID = WHAT YOU USE IN ROUTES (E.G., ARCHFIND-XXXX)
-- ---------------------------------------------------------
CREATE TABLE IF NOT EXISTS PROJECTS (
  PUBLIC_ID TEXT PRIMARY KEY,
  USER_FIREBASE_UID TEXT NOT NULL REFERENCES USERS(FIREBASE_UID) ON DELETE CASCADE,

  NAME TEXT NOT NULL,
  IS_TEMPORARY BOOLEAN NOT NULL DEFAULT FALSE,
  DELETED_AT TIMESTAMPTZ,

  -- POINTS TO DIAGRAM_VERSIONS.ID (TEXT) - CAN BE NULL
  CURRENT_DIAGRAM_VERSION_ID TEXT,

  CREATED_AT TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  UPDATED_AT TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS IDX_PROJECTS_USER
ON PROJECTS(USER_FIREBASE_UID)
WHERE DELETED_AT IS NULL;

DROP TRIGGER IF EXISTS TRG_PROJECTS_UPDATED_AT ON PROJECTS;
CREATE TRIGGER TRG_PROJECTS_UPDATED_AT
BEFORE UPDATE ON PROJECTS
FOR EACH ROW EXECUTE FUNCTION UPDATE_UPDATED_AT_COLUMN();

-- ---------------------------------------------------------
-- DIAGRAM VERSIONS (APP-GENERATED TEXT ID)
-- ---------------------------------------------------------
CREATE TABLE IF NOT EXISTS DIAGRAM_VERSIONS (
  ID TEXT PRIMARY KEY, -- GENERATED BY APP (UUID/ULID/STRING)

  PROJECT_PUBLIC_ID TEXT NOT NULL REFERENCES PROJECTS(PUBLIC_ID) ON DELETE CASCADE,
  USER_FIREBASE_UID TEXT NOT NULL REFERENCES USERS(FIREBASE_UID) ON DELETE CASCADE,

  VERSION_NUMBER INT NOT NULL,
  SOURCE TEXT NOT NULL,            -- 'canvas_json' | 'chat_upload' | 'image_ocr'
  DIAGRAM_JSON JSONB,              -- RAW DIAGRAM JSON
  IMAGE_OBJECT_KEY TEXT,           -- STORAGE KEY (S3/MINIO/LOCAL)
  SPEC_SUMMARY JSONB,              -- NORMALIZED SUMMARY FOR LLM
  HASH TEXT,                       -- OPTIONAL DEDUPE HASH
  CREATED_BY TEXT REFERENCES USERS(FIREBASE_UID),

  CREATED_AT TIMESTAMPTZ NOT NULL DEFAULT NOW(),

  UNIQUE (PROJECT_PUBLIC_ID, VERSION_NUMBER)
);

CREATE INDEX IF NOT EXISTS IDX_DIAGRAM_VERSIONS_PROJECT
ON DIAGRAM_VERSIONS(PROJECT_PUBLIC_ID, VERSION_NUMBER DESC);

CREATE INDEX IF NOT EXISTS IDX_DIAGRAM_VERSIONS_USER
ON DIAGRAM_VERSIONS(USER_FIREBASE_UID);

CREATE INDEX IF NOT EXISTS IDX_DIAGRAM_VERSIONS_HASH
ON DIAGRAM_VERSIONS(HASH);

-- NOW THAT DIAGRAM_VERSIONS EXISTS, ADD FK FOR CURRENT_DIAGRAM_VERSION_ID
ALTER TABLE PROJECTS
DROP CONSTRAINT IF EXISTS PROJECTS_CURRENT_DIAGRAM_VERSION_FK;

ALTER TABLE PROJECTS
ADD CONSTRAINT PROJECTS_CURRENT_DIAGRAM_VERSION_FK
FOREIGN KEY (CURRENT_DIAGRAM_VERSION_ID)
REFERENCES DIAGRAM_VERSIONS(ID)
ON DELETE SET NULL;

-- ---------------------------------------------------------
-- CHAT THREADS (APP-GENERATED TEXT ID)
-- ---------------------------------------------------------
CREATE TABLE IF NOT EXISTS CHAT_THREADS (
  ID TEXT PRIMARY KEY, -- GENERATED BY APP

  PROJECT_PUBLIC_ID TEXT NOT NULL REFERENCES PROJECTS(PUBLIC_ID) ON DELETE CASCADE,
  USER_FIREBASE_UID TEXT NOT NULL REFERENCES USERS(FIREBASE_UID) ON DELETE CASCADE,

  TITLE TEXT,
  BINDING_MODE TEXT NOT NULL DEFAULT 'FOLLOW_LATEST', -- 'FOLLOW_LATEST' | 'PINNED'
  PINNED_DIAGRAM_VERSION_ID TEXT REFERENCES DIAGRAM_VERSIONS(ID),

  CREATED_AT TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS IDX_CHAT_THREADS_PROJECT
ON CHAT_THREADS(PROJECT_PUBLIC_ID, CREATED_AT DESC);

CREATE INDEX IF NOT EXISTS IDX_CHAT_THREADS_USER
ON CHAT_THREADS(USER_FIREBASE_UID, CREATED_AT DESC);

-- ---------------------------------------------------------
-- CHAT MESSAGES (APP-GENERATED TEXT ID)
-- ---------------------------------------------------------
CREATE TABLE IF NOT EXISTS CHAT_MESSAGES (
  ID TEXT PRIMARY KEY, -- GENERATED BY APP

  THREAD_ID TEXT NOT NULL REFERENCES CHAT_THREADS(ID) ON DELETE CASCADE,
  PROJECT_PUBLIC_ID TEXT NOT NULL REFERENCES PROJECTS(PUBLIC_ID) ON DELETE CASCADE,
  USER_FIREBASE_UID TEXT NOT NULL REFERENCES USERS(FIREBASE_UID) ON DELETE CASCADE,

  ROLE TEXT NOT NULL,      -- 'user' | 'assistant'
  CONTENT TEXT NOT NULL,
  SOURCE TEXT,             -- 'rag' | 'llm' | 'guardrails'
  REFS JSONB,              -- CITATIONS/SNIPPETS/ETC

  DIAGRAM_VERSION_ID_USED TEXT REFERENCES DIAGRAM_VERSIONS(ID),

  CREATED_AT TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS IDX_CHAT_MESSAGES_THREAD
ON CHAT_MESSAGES(THREAD_ID, CREATED_AT);

CREATE INDEX IF NOT EXISTS IDX_CHAT_MESSAGES_PROJECT
ON CHAT_MESSAGES(PROJECT_PUBLIC_ID, CREATED_AT);

CREATE INDEX IF NOT EXISTS IDX_CHAT_MESSAGES_USER
ON CHAT_MESSAGES(USER_FIREBASE_UID, CREATED_AT);

-- ---------------------------------------------------------
-- CHAT MESSAGES ATTACHMENT
-- ---------------------------------------------------------

CREATE TABLE IF NOT EXISTS CHAT_MESSAGE_ATTACHMENTS (
  ID TEXT PRIMARY KEY,
  MESSAGE_ID TEXT NOT NULL REFERENCES CHAT_MESSAGES(ID) ON DELETE CASCADE,

  KIND TEXT NOT NULL DEFAULT 'image',
  OBJECT_KEY TEXT NOT NULL,

  MIME_TYPE TEXT,
  FILE_NAME TEXT,
  FILE_SIZE_BYTES BIGINT,
  WIDTH INT,
  HEIGHT INT,

  CREATED_AT TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS IDX_CHAT_MESSAGE_ATTACHMENTS_MESSAGE
ON CHAT_MESSAGE_ATTACHMENTS(MESSAGE_ID);
